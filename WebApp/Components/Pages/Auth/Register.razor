@page "/register"
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject LookupService LookupService
@inject ILogger<Register> Logger
@using global::System.Text.RegularExpressions
@using global::System.Data.Common
@using Microsoft.EntityFrameworkCore

<PageTitle>Регистрация</PageTitle>

<section class="hero-card narrow">
    <div class="section-header">
        <div>
            <h1 class="section-title">Создать аккаунт</h1>
            <p class="section-sub">Заполните профиль, чтобы отслеживать заявки и договариваться о показах.</p>
            <div class="badges">
                <span class="tag-pill primary">Риелторы и клиенты</span>
                <span class="tag-pill">Уведомления по заявкам</span>
            </div>
        </div>
    </div>
    <div class="split-card">
        <div class="panel">
            @if (!string.IsNullOrEmpty(Error))
            {
                <div class="alert">@Error</div>
            }

            <EditForm Model="Model" OnValidSubmit="RegisterAsync" FormName="registerForm" class="form-stack">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="grid-two">
                    <label>Фамилия
                        <InputText @bind-Value="Model.LastName" />
                        <ValidationMessage For="@(() => Model.LastName)" />
                    </label>
                    <label>Имя
                        <InputText @bind-Value="Model.FirstName" />
                        <ValidationMessage For="@(() => Model.FirstName)" />
                    </label>
                </div>
                <label>Отчество
                    <InputText @bind-Value="Model.MiddleName" />
                    <ValidationMessage For="@(() => Model.MiddleName)" />
                </label>
                <div class="grid-two">
                    <label>Email
                        <InputText @bind-Value="Model.Email" type="email" />
                        <ValidationMessage For="@(() => Model.Email)" />
                    </label>
                    <label>Телефон
                        <InputText @bind-Value="Model.Phone" @bind-Value:event="oninput" type="tel" inputmode="tel" pattern="[0-9+()\\-\\s]*" />
                        <ValidationMessage For="@(() => Model.Phone)" />
                    </label>
                </div>
                <label>Пароль
                    <InputText @bind-Value="Model.Password" type="password" />
                    <ValidationMessage For="@(() => Model.Password)" />
                </label>
                <label>Роль
                    <InputSelect @bind-Value="Model.Role">
                        @foreach (var role in Roles)
                        {
                            <option value="@role.Name">@role.DisplayName</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => Model.Role)" />
                </label>
                <button type="submit">Зарегистрироваться</button>
            </EditForm>
        </div>
        <div class="panel highlight">
            <h3>Готовые профили</h3>
            <p class="muted">Используйте преднастроенные роли, чтобы сразу перейти к интерфейсам клиента, риелтора или администратора.</p>
            <ul class="checklist">
                <li><strong>client@example.com</strong> · Покупатель</li>
                <li><strong>agent@example.com</strong> · Риелтор</li>
                <li><strong>admin@example.com</strong> · Администратор</li>
            </ul>
            <p class="muted">Пароль для всех: <code>Password123!</code></p>
            <NavLink class="primary ghost" href="/login">Перейти ко входу</NavLink>
        </div>
    </div>
</section>

@code {
    private readonly RegisterInputModel Model = new();
    private List<DataLayer.Models.Role> Roles { get; set; } = new();
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var roles = await LookupService.GetRolesAsync();
            Roles = roles.Where(r => r.Name != "admin").ToList();

            if (Roles.Count == 0)
            {
                Error = DatabaseErrorMessages.ConnectionFailed;
                return;
            }

            Model.Role = Roles.FirstOrDefault()?.Name ?? "client";
        }
        catch (InvalidOperationException ex)
        {
            var message = DatabaseErrorMessages.Resolve(ex);
            Logger.LogError(ex, message);
            Error = message;
        }
        catch (Exception ex)
        {
            var message = DatabaseErrorMessages.Resolve(ex);
            Logger.LogError(ex, message);
            Error = message;
        }
    }

    private async Task RegisterAsync()
    {
        Error = null;
        var userCreated = false;

        try
        {
            if (Roles.Count == 0)
            {
                Error = "Регистрация недоступна: не удалось подключиться к базе данных.";
                return;
            }

            var normalizedEmail = Model.Email.Trim().ToUpperInvariant();
            var existingUser = await UserManager.FindByEmailAsync(normalizedEmail);
            if (existingUser is not null)
            {
                Error = "Пользователь с таким email уже зарегистрирован.";
                return;
            }

            var role = Roles.FirstOrDefault(r => r.Name == Model.Role);
            if (role is null)
            {
                Error = "Выбранная роль недоступна. Попробуйте снова.";
                return;
            }
            var user = new ApplicationUser
            {
                Email = Model.Email.Trim(),
                UserName = Model.Email.Trim(),
                NormalizedEmail = normalizedEmail,
                NormalizedUserName = normalizedEmail,
                PhoneNumber = Model.Phone,
                LastName = Model.LastName,
                FirstName = Model.FirstName,
                MiddleName = string.IsNullOrWhiteSpace(Model.MiddleName) ? null : Model.MiddleName,
                RoleId = role.Id,
                RoleName = role.Name
            };

            var result = await UserManager.CreateAsync(user, Model.Password);
            if (result.Succeeded)
            {
                userCreated = true;

                await UserManager.AddToRoleAsync(user, role.Name);
                await SignInManager.SignInAsync(user, isPersistent: true);
                NavigationManager.NavigateTo("/");
                return;
            }

            Error = string.Join("; ", result.Errors.Select(e => e.Description));
        }
        catch (DbUpdateException ex)
        {
            // MySQL может вернуть 1062 (duplicate key) или другие коды, пробуем перевести их в понятное сообщение.
            var message = DatabaseErrorMessages.Resolve(ex.InnerException as DbException); // DbUpdateException не DbException, но может содержать его внутри
            Logger.LogError(ex, message);
            Error = message;
        }
        catch (InvalidOperationException ex)
        {
            Logger.LogError(ex, ex.Message);
            Error = ex.Message;
        }
        catch (Exception ex)
        {
            var message = userCreated
                ? "Аккаунт создан, но завершить вход не удалось. Попробуйте войти вручную."
                : "Не удалось завершить регистрацию. Попробуйте позже.";
            Logger.LogError(ex, message);
            Error = message;
        }
    }

    private void FilterPhone(ChangeEventArgs args)
    {
        var rawValue = args.Value?.ToString() ?? string.Empty;
        var sanitized = Regex.Replace(rawValue, "[^0-9+()\\-\\s]", string.Empty);

        Model.Phone = sanitized;
    }
}
